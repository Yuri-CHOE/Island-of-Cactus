using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public struct IocEffect
{
    // 활성화 이펙트 목록
    public static List<IocEffect> activeEffects = new List<IocEffect>();


    // 유효기간
    public enum Expiration
    {
        Never,
        Forever,
        Cycle,
        Turn,
        Moment,
        Invalid,
    }

    // 타겟 플레이어
    public enum Target
    {
        Self,
        AllPlayer,
        OthersPlayer,
        SelectedPlayer,
        World,
    }

    // 대상 필드
    public enum What
    {
        None,
        Character,
        Move,
        Block,
        Dice,
        Life,
        Coin,
        Item,
        Minigame,
    }




    // 효과 유효기간
    Expiration _expiration ;
    public Expiration expiration { get { return _expiration; } }
    public bool isInvalid { get { return expiration == Expiration.Invalid; } }

    // 효과 카운트(개수)
    int _count;
    public int count { get { return _count; } }

    // 효과 타겟 플레이어 (사용자와의 관계)
    Target _target;
    public Target target { get { return _target; } }

    // 효과 시작점
    int _where;
    public int where { get { return _where; } }

    // 효과 대상
    What _what;
    public What what { get { return _what; } }

    // 효과 값
    int _value;
    public int value { get { return _value; } }




    /// <summary>
    /// 재설정 함수, 별도 사용하지 말것
    /// </summary>
    /// <param name="__expiration">잔존 기간</param>
    /// <param name="__count">발동 횟수</param>
    /// <param name="__target">발동자에 의해 가공된 효과 적용 대상</param>
    /// <param name="__where">발동 지점으로부터 거리</param>
    /// <param name="__what">효과 종류</param>
    /// <param name="__value">효과 값</param>
    public void Set(Expiration __expiration, int __count, Target __target, int __where, What __what, int __value)
    {
        SetExpiration(__expiration);
        SetCount(__count);
        SetTarget(__target);
        SetWhere(__where);
        SetWhat(__what);
        SetValue(__value);
    }

    void SetExpiration(Expiration __expiration)
    {
        _expiration = __expiration;
    }

    void SetCount(int __count)
    {
        if (__count < 0)
            return;

        _count = __count;
    }

    void SetTarget(Target __target)
    {
        _target = __target;
    }

    void SetWhere(int __where)
    {
        _where = __where;
    }

    void SetWhat(What __what)
    {
        _what = __what;
    }

    void SetValue(int __value)
    {
        _value = __value;
    }
















    /// <summary>
    /// 효과를 적용받을 플레이어 리스트
    /// SelectedPlayer 는 빈 리스트 반환
    /// World 는 null 반환
    /// </summary>
    /// <param name="__iocEvent">이벤트</param>
    /// <param name="targetPlayer_Or_null">발동자 또는 null</param>
    /// <returns></returns>
    public static List<Player> TargetFiltering(Target target, Player targetPlayer_Or_null)
    {
        // 결과물
        List<Player> pl = new List<Player>();

        // 자기 자신
        if (target == Target.Self)
            pl.Add(targetPlayer_Or_null);

        // 모든 플레이어
        else if (target == Target.AllPlayer)
            pl.AddRange(Player.allPlayer);

        // 다른 플레이어
        else if (target == Target.OthersPlayer)
            pl.AddRange(targetPlayer_Or_null.otherPlayers);

        // 다른 플레이어
        else if (target == Target.SelectedPlayer)
            ;

        // 맵 광역
        else if (target == Target.World)
            return null;

        return pl;
    }


    /// <summary>
    /// 실제 효과 발동
    /// </summary>
    /// <param name="filteredTarget">효과를 받을 플레이어들</param>
    /// <param name="__blockIndex">위치</param>
    public IEnumerator GeneralEffect(Player user, List<Player> filteredTarget)
    {
        // 소모 처리
        if (_count == 1)        _count = -1;
        else if (_count > 0)    _count--;


        // 월드 이벤트 호출
        if (filteredTarget == null)
        {
            // 미구현 ============
            // yeild return WorldEvent();
        }
        else
        {
            // 선택형 선택 =========== 미구현
            //if (filteredTarget.Count == 0)
            //yield return ;


            Player current = null;
            int blockIndex;
            bool isExecute;

            for (int i = 0; i < filteredTarget.Count; i++)
            {
                // 퀵등록
                current = filteredTarget[i];

                // 이동 포인트 확보
                blockIndex = current.location;

                // 효과 적용 여부
                isExecute = true;



                // 사용자 불일치 경우
                if (current != user)
                {
                    // 인벤토리 스캔
                    for (int j = 0; j < current.inventory.Count; j++)
                    {
                        // 실드 체크
                        if (current.inventory[j].item.index == 19)
                        {
                            // 실드 자동 사용
                            GameMaster.script.itemManager.ItemUse(current.inventory[j]);

                            // 스캔 중단
                            break;
                        }
                    }
                }



                // 효과 차단
                if (isExecute)
                    continue;

                // 대상 없음
                if (what == What.None)
                {

                }

                // 캐릭터 (플레이어 아바타)
                else if (what == What.Character)
                {
                    // 미구현 ===================================
                }

                // 이동
                else if (what == What.Move)
                {
                    // 중단
                    current.movement.MoveStop();

                    // 이동 포인트 가공
                    if (value == -3)
                    {
                        //blockIndex *= where;
                        current.dice.SetValue(current.dice.value * where);

                        // 이동 호출
                        current.movement.PlanMoveBy(current.dice.valueTotal);
                    }
                    else if (value == -2)
                    {
                        //blockIndex += where;
                        current.dice.SetValue(current.dice.value + where);

                        // 이동 호출
                        current.movement.PlanMoveBy(current.dice.valueTotal);
                    }
                    else
                    {
                        //blockIndex = value;
                        current.dice.SetValue(where);

                        // 이동 호출
                        current.movement.PlanMoveTo(blockIndex);
                    }

                }

                // 블록 타입 변경
                else if (what == What.Block)
                {
                    // 퀵등록
                    DynamicBlock dBlock = BlockManager.script.GetBlock(where).GetComponent<DynamicBlock>();

                    // 설정
                    dBlock.blockTypeDetail = (BlockType.TypeDetail)value;
                    dBlock.blockType = BlockType.GetTypeByDetail(dBlock.blockTypeDetail);
                    dBlock.Refresh();
                }

                // 주사위 제어
                else if (what == What.Dice)
                {
                    if (value != 0)
                        // 주사위 추가
                        current.dice.count += value;
                    else
                        // 주사위 변경
                        current.dice.type = (Dice.SpecialDice)where;
                }

                // 라이프 획득
                else if (what == What.Life)
                {
                    current.life.Add(value);
                }

                // 코인 획득
                else if (what == What.Coin)
                {
                    current.coin.Add(value);
                }

                // 아이템 획득
                else if (what == What.Item)
                {
                    if(value > 0)
                        if (value < Item.table.Count)
                            current.AddItem(Item.table[value], count);
                }

                // 미니게임 수행
                else if (what == What.Minigame)
                {
                    // 미구현 ===================================
                }
            }

        }


        // 사용된 효과 등록
        if (expiration == Expiration.Forever || expiration == Expiration.Cycle || expiration == Expiration.Turn)
        {
            // 소모처리
            _count--;
            
            // 효과 등록
            if (!activeEffects.Contains(this))
                activeEffects.Add(this);
        }
        // 즉시 만료
        else
            _expiration = Expiration.Invalid;

        Debug.Log("ioc effect :: 효과 작동됨");

        yield return null;
    }
}
